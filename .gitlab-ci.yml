stages:
  - build
  - test
  - publish

services:
  - docker:dind

test-images:
  image: docker:latest
  stage: build
  script:
    # These images will be tested (see docker-compose.ci.yml)
    - docker build -t simonlorenz/mampfalot:test -f ./server/Dockerfile ./server
    - docker save simonlorenz/mampfalot:test > mampfalot.test.tar
  artifacts:
    untracked: false
    expire_in: 10 mins
    paths:
      - mampfalot.test.tar

dev-images:
  image: docker:latest
  stage: build
  script:
    - docker build -t simonlorenz/mampfalot-client:dev -f ./client/Dockerfile.dev ./client
    - docker save simonlorenz/mampfalot-client:dev > mampfalot-client.dev.tar
  artifacts:
    untracked: false
    expire_in: 10 mins
    paths:
      - mampfalot-client.dev.tar
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'

production-images:
  image: docker:latest
  stage: build
  script:
    - docker build -t simonlorenz/mampfalot:latest -f ./server/Dockerfile.prod ./server
    - docker build -t simonlorenz/mampfalot-client:latest -f ./client/Dockerfile.prod ./client
    - docker save simonlorenz/mampfalot:latest > mampfalot.latest.tar
    - docker save simonlorenz/mampfalot-client:latest > mampfalot-client.latest.tar
  artifacts:
    untracked: false
    expire_in: 10 mins
    paths:
      - mampfalot.latest.tar
      - mampfalot-client.latest.tar
  rules:
    - if: '$CI_COMMIT_TAG != null'

lint:
  image: simonlorenz/docker-with-compose
  stage: test
  script:
    - docker load < mampfalot.test.tar
    - docker-compose -f docker-compose.ci.yml run server-test npm run lint

test:
  image: simonlorenz/docker-with-compose
  stage: test
  script:
    - docker load < mampfalot.test.tar
    - docker-compose -f docker-compose.ci.yml run server-test npm run test

production:
  image: docker:latest
  stage: publish
  script:
    - docker load < mampfalot.latest.tar
    - docker load < mampfalot-client.latest.tar

    - docker login -u simonlorenz -p $DOCKER_ACCESS_TOKEN

    - docker tag simonlorenz/mampfalot:latest simonlorenz/mampfalot:$CI_COMMIT_TAG
    - docker tag simonlorenz/mampfalot-client:latest simonlorenz/mampfalot-client:$CI_COMMIT_TAG

    - docker push simonlorenz/mampfalot:$CI_COMMIT_TAG
    - docker push simonlorenz/mampfalot:latest
    - docker push simonlorenz/mampfalot-client:$CI_COMMIT_TAG
    - docker push simonlorenz/mampfalot-client:latest
  rules:
    - if: '$CI_COMMIT_TAG != null'

dev:
  image: docker:latest
  stage: publish
  script:
    - docker load < mampfalot.latest.tar
    - docker load < mampfalot-client.dev.tar

    - docker login -u simonlorenz -p $DOCKER_ACCESS_TOKEN

    - docker tag simonlorenz/mampfalot:latest simonlorenz/mampfalot:dev

    - docker push simonlorenz/mampfalot:dev
    - docker push simonlorenz/mampfalot-client:dev
  rules:
    - if: '$CI_COMMIT_REF_NAME == "dev"'
